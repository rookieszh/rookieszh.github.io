---
title: Transaction ACID
date: 2019-03-07 10:13:36
categories:
    - SQL
tags:
    - Mysql
    - transaction
description: "从本文开始将介绍Mysql的进阶用法——事务ACID"
fancybox: true  # 图片浏览器
toc: true       # 文章目录
original: true  # 文末版权信息 
comments: true  # 文末评论
share: true     # 分享
---

#### 事务ACID
> 一个sql语句就是一个事务
> 事务可以保证一组sql语句要么都成功，要么都失败，默认自动提交
> [知乎事务详述](https://zhuanlan.zhihu.com/p/29166694)
##### 事务的特性
* 原子性 Atomicity：一个事务必须被视为一个不可分割的最小工作单元，整个事务中的所有操作要么全部提交成功，要么全部失败回滚，对于一个事务来说，不可能只执行其中的一部分操作。
* 一致性 Consistency：数据库总是从一个一致性状态转换到另一个一致状态。让数据保持逻辑上的‘合理性’。
* 隔离性 Isolation：通常来说，一个事务所做的修改在最终提交以前，对其他事务是不可见的。在事务A提交之前，事务B观察不到数据的改变。
* 持久性 Durability：一个事务执行成功，则对数据来说应该是一个明确的硬盘数据变更（而不仅仅是内存中的变化）。此时即使系统崩溃，修改的数据也不会丢失。
* 事务的隔离性是通过锁，MVCC等实现；原子性、一致性、持久性是通过事务日志实现
##### 并发事务带来的问题
###### 脏读 Dirty read
当一个事务正在访问数据并且对数据进行了修改，而这种修改还没有提交到数据库中，这时另外一个事务也访问了这个数据，然后使用了这个数据。因为这个数据是还没有提交的数据，那么另外一个事务读到的这个数据是“脏数据”，依据“脏数据”所做的操作可能是不正确的。
###### 丢失修改 Lost to modify
指在一个事务读取一个数据时，另外一个事务也访问了该数据，那么在第一个事务中修改了这个数据后，第二个事务也修改了这个数据。这样第一个事务内的修改结果就被丢失，因此称为丢失修改。例如：事务1读取某表中的数据A=20，事务2也读取A=20，事务1修改A=A-1，事务2也修改A=A-1，最终结果A=19，事务1的修改被丢失。
###### 不可重复读 Unrepeatableread
指在一个事务内多次读同一数据。在这个事务还没有结束时，另一个事务也访问该数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改导致第一个事务两次读取的数据可能不太一样。这就发生了在一个事务内两次读到的数据是不一样的情况，因此称为不可重复读。
###### 幻读 Phantom read
幻读与不可重复读类似。它发生在一个事务（T1）读取了几行数据，接着另一个并发事务（T2）插入了一些数据时。在随后的查询中，第一个事务（T1）就会发现多了一些原本不存在的记录，就好像发生了幻觉一样，所以称为幻读。
###### 不可重复度和幻读区别
不可重复读的重点是修改，幻读的重点在于新增或者删除。
##### 事务隔离级别
###### 读取未提交 READ-UNCOMMITTED
最低的隔离级别，允许读取尚未提交的数据变更，可能会导致脏读、幻读或不可重复读。
###### 读取已提交 READ-COMMITTED
允许读取并发事务已经提交的数据，可以阻止脏读，但是幻读或不可重复读仍有可能发生。
###### 可重复读 REPEATABLE-READ
对同一字段的多次读取结果都是一致的，除非数据是被本身事务自己所修改，可以阻止脏读和不可重复读，但幻读仍有可能发生。
###### 可串行化 SERIALIZABLE
最高的隔离级别，完全服从ACID的隔离级别。所有的事务依次逐个执行，这样事务之间就完全不可能产生干扰，也就是说，该级别可以防止脏读、不可重复读以及幻读。
###### MySQL默认隔离级别
InnoDB 存储引擎的默认支持的隔离级别是 REPEATABLE-READ（可重读）。
```sql
SELECT @@tx_isolation;
+-----------------+
| @@tx_isolation  |
+-----------------+
| REPEATABLE-READ |
+-----------------+
```
与 SQL 标准不同的地方在于InnoDB 存储引擎在 REPEATABLE-READ（可重读）事务隔离级别下使用的是Next-Key Lock 锁算法，因此可以避免幻读的产生，这与其他数据库系统(如 SQL Server)是不同的。所以说InnoDB 存储引擎的默认支持的隔离级别是 REPEATABLE-READ（可重读） 已经可以完全保证事务的隔离性要求，即达到了 SQL标准的SERIALIZABLE(可串行化)隔离级别。

因为隔离级别越低，事务请求的锁越少，所以大部分数据库系统的隔离级别都是READ-COMMITTED(读取提交内容)，但是InnoDB 存储引擎默认使用 REPEATABLE-READ（可重读）并不会有任何性能损失。

InnoDB 存储引擎在 分布式事务 的情况下一般会用到SERIALIZABLE(可串行化)隔离级别。
